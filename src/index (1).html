<!DOCTYPE html>
<html>
<head>
  <title>OpenID Connect Login</title>
</head>
<body>
  <h1>Login with OpenID Connect</h1>
  <div>
  <button id="login-button">Login with PKCE</button>
  
</div>

<div>
  <button id="implicit-token-login-button">Login with implicit flow (Access Token)</button>
</div>

<div>
  <button id="implicit-login-button">Login with implicit flow (Access token + ID token)</button>
  
</div>


<div>
  <button id="hybrid-pkce-login-button">Login with hybrid flow (auth code + Token)</button>
</div>

<div>
  <button id="hybrid-token-login-button">Login with hybrid flow (auth code + ID Token)</button>
</div>

<div>
  <button id="logout-button">Logout</button>
</div>

</body>
<script type="text/javascript">


const logoutButton = document.getElementById('logout-button');
//logout button
logoutButton.addEventListener('click', async () => {
  // Replace with your authorization server and client details
  const logoutUrl = 'http://localhost:8085/realms/test/protocol/openid-connect/logout';
  const clientId = localStorage.getItem('clientId');
  const redirectUri = 'http://localhost/index.html';


  // Build the authorization URL with parameters
  const url = new URL(logoutUrl);
  url.searchParams.set('response_type', 'code');
  url.searchParams.set('client_id', clientId);
  url.searchParams.set('post_logout_redirect_uri', redirectUri);
  // Redirect the user to the authorization server
  localStorage.clear();
  window.location.href = url.toString();
});

////////////////////////////////////////////////////////////////////////////////////////////

const loginButton = document.getElementById('login-button');

//pkce flow
function base64urlencode(str) {
  return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

function generateNonce(){
  return Array.from(window.crypto.getRandomValues(new Uint32Array(28)),dec => ('0' + dec.toString(16)).substr(-2)).join('');
}

function generateState(){
  return Array.from(window.crypto.getRandomValues(new Uint32Array(28)),dec => ('0' + dec.toString(16)).substr(-2)).join('');
}

async function  generatePKCEPair() {
  const code = Array.from(  
    window.crypto.getRandomValues(new Uint32Array(28)), 
    dec => ('0' + dec.toString(16)).substr(-2)
  ).join('');
  const challenge = base64urlencode(
    await window.crypto.subtle.digest('SHA-256', new TextEncoder().encode(code))
  );
  return {code, challenge};
}

generatePKCEPair().then((res) => {
  
  localStorage.setItem("challenge", res.challenge);
  localStorage.setItem("code", res.code);
  console.log(res);
})

const nonce=generateNonce();
localStorage.setItem("nonce", nonce);

const state=generateState();
localStorage.setItem("state", state);

loginButton.addEventListener('click', async () => {

  //first i generate the codes

  // Replace with your authorization server and client details
  const authUrl = 'http://localhost:8085/realms/test/protocol/openid-connect/auth';
  const clientId = 'pkce-test-client';
  const redirectUri = 'http://localhost/callback.html';
  const scope = 'openid profile'; // Adjust based on your needs
  const state = "random"
  //we set the client id
  localStorage.setItem('clientId',clientId);
  // Build the authorization URL with parameters
  const url = new URL(authUrl);
  url.searchParams.set('response_type', 'code');
  url.searchParams.set('client_id', clientId);
  url.searchParams.set('redirect_uri', redirectUri);
  url.searchParams.set('scope', scope);
  url.searchParams.set('state', state);
  url.searchParams.set('code_challenge', localStorage.getItem("challenge"));
  url.searchParams.set('code_challenge_method', 'S256');

  // Redirect the user to the authorization server
  window.location.href = url.toString();
});


//////////////////////////////////////////////////////////////////////////////////
//implicit flow + pkce
const implicitLoginButton = document.getElementById('implicit-login-button');



implicitLoginButton.addEventListener('click', async () => {
  

  // Replace with your authorization server and client details
  const authUrl = 'http://localhost:8085/realms/test/protocol/openid-connect/auth';
  const clientId = 'implicit-test-client';
  const redirectUri = 'http://localhost/callback.html';
  const scope = 'openid profile'; // Adjust based on your needs
  const state = "random";
  const nonce = 'a4ndhGndhjzgjdna';

 
  //we set the client id
  localStorage.setItem('clientId',clientId);
  // Build the authorization URL with parameters
  const url = new URL(authUrl);
  url.searchParams.set('response_type', 'id_token token');
  //url.searchParams.set('response_mode', 'query');
  url.searchParams.set('client_id', clientId);
  url.searchParams.set('redirect_uri', redirectUri);
  url.searchParams.set('scope', scope);
  url.searchParams.set('state', state);
  url.searchParams.set('nonce', nonce);


  // Redirect the user to the authorization server
  window.location.href = url.toString();
});


//////////////////////////////////////////////////////////////////////////////////
//implicit flow
const implicitTokenLoginButton = document.getElementById('implicit-token-login-button');



implicitTokenLoginButton.addEventListener('click', async () => {
  

  // Replace with your authorization server and client details
  const authUrl = 'http://localhost:8085/realms/test/protocol/openid-connect/auth';
  const clientId = 'implicit-flow-client';
  const redirectUri = 'http://localhost/callback.html';
  const scope = 'openid profile'; // Adjust based on your needs
  const state = "random";
  const type = 'token';
 
  //we set the client id
  localStorage.setItem('clientId',clientId);
  // Build the authorization URL with parameters
  const url = new URL(authUrl);
  url.searchParams.set('response_type', type);
  //url.searchParams.set('response_mode', 'query');
  url.searchParams.set('client_id', clientId);
  url.searchParams.set('redirect_uri', redirectUri);
  url.searchParams.set('scope', scope);
  url.searchParams.set('state', state);
  //url.searchParams.set('OnLoad', 'check-sso');

  // Redirect the user to the authorization server
  window.location.href = url.toString();
});

//////////////////////////////////////////////////////////////////////////////////
//hybrid flow + pkce 
const hybridPkceLoginButton = document.getElementById('hybrid-pkce-login-button');



hybridPkceLoginButton.addEventListener('click', async () => {
  

  // Replace with your authorization server and client details
  const authUrl = 'http://localhost:8085/realms/test/protocol/openid-connect/auth';
  const clientId = 'hybrid-flow-client';
  const redirectUri = 'http://localhost/callback.html';
  const scope = 'openid profile'; // Adjust based on your needs
  const state = "random";
  
 
  //we set the client id
  localStorage.setItem('clientId',clientId);
  // Build the authorization URL with parameters
  const url = new URL(authUrl);
  url.searchParams.set('response_type', 'code token');
  //url.searchParams.set('response_mode', 'query');
  url.searchParams.set('client_id', clientId);
  url.searchParams.set('redirect_uri', redirectUri);
  url.searchParams.set('scope', scope);
  url.searchParams.set('state', state);
  url.searchParams.set('code_challenge', localStorage.getItem("challenge"));
  url.searchParams.set('code_challenge_method', 'S256');
  //url.searchParams.set('OnLoad', 'check-sso');

  // Redirect the user to the authorization server
  window.location.href = url.toString();
});


//////////////////////////////////////////////////////////////////////////////////
//hybrid flow + pkce + id_token
const hybridTokenLoginButton = document.getElementById('hybrid-token-login-button');



hybridTokenLoginButton.addEventListener('click', async () => {
  

  // Replace with your authorization server and client details
  const authUrl = 'http://localhost:8085/realms/test/protocol/openid-connect/auth';
  const clientId = 'hybrid-test-client';
  const redirectUri = 'http://localhost/callback.html';
  const scope = 'openid profile'; // Adjust based on your needs
  const state = "random";
  const type = 'code id_token';
  const nonce = 'a4ndhGndhjzgjdna';

  //we set the client id
  localStorage.setItem('clientId',clientId);
  // Build the authorization URL with parameters
  const url = new URL(authUrl);
  url.searchParams.set('response_type', type);
  //url.searchParams.set('response_mode', 'query');
  url.searchParams.set('client_id', clientId);
  url.searchParams.set('redirect_uri', redirectUri);
  url.searchParams.set('scope', scope);
  url.searchParams.set('state', state);
  url.searchParams.set('nonce', nonce);
  url.searchParams.set('code_challenge', localStorage.getItem("challenge"));
  url.searchParams.set('code_challenge_method', 'S256');
  //url.searchParams.set('OnLoad', 'check-sso');

  // Redirect the user to the authorization server
  window.location.href = url.toString();
});


//http://localhost:8085/realms/test/protocol/openid-connect/logout?redirect_uri=http://localhost/index.html
//http://localhost:8085/realms/test/.well-known/openid-configuration
</script>
</html>